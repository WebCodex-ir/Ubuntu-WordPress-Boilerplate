# 🚀 اسکریپت نصب سرور وردپرس حرفه‌ای (نسخه نهایی)

این اسکریپت برای راه‌اندازی سریع و خودکار یک سرور وردپرس کامل، بهینه و امن بر روی سیستم‌عامل **Ubuntu 24.04 LTS** طراحی شده است. این پروژه نتیجه یک پروسه دیباگ جامع و یادگیری عمیق برای رسیدن به یک راه حل پایدار و قابل اعتماد است.

## ✨ ویژگی‌ها و تکنولوژی‌های نصب شده

* ✅ **وب سرور:** **Apache2** (برای حداکثر پایداری و سازگاری)
* ✅ **دیتابیس:** **MariaDB** (جایگزین مدرن و بهینه MySQL)
* ✅ **محیط اجرا:** **PHP** (آخرین نسخه پایدار به همراه تمام افزونه‌های ضروری)
* ✅ **کش سرور:** **Redis** (برای کش آبجکت و کاهش فشار روی دیتابیس)
* ✅ **امنیت SSL:** گواهی رایگان **Let's Encrypt** با نصب و تمدید کاملاً خودکار.
* ✅ **فشرده‌سازی:** **Brotli** (الگوریتم فشرده‌سازی مدرن گوگل برای سرعت بالاتر)
* ✅ **پروتکل وب:** **HTTP/2** (برای بارگذاری موازی و سریع‌تر منابع سایت)
* ✅ **فایروال برنامه وب (WAF):** **ModSecurity** به همراه قوانین OWASP برای محافظت در برابر حملات وب.
* ✅ **امنیت شبکه:** فایروال **UFW** و سیستم ضدحمله **Fail2Ban**.
* ✅ **انتقال فایل امن:** **SFTP** به صورت پیش‌فرض با دسترسی SSH فعال است.
* ✅ **کنترل خطا:** اسکریپت در هر مرحله موفقیت را بررسی کرده و در صورت بروز مشکل با پیغام واضح متوقف می‌شود.

## 📋 پیش‌نیازها

1.  یک سرور با سیستم‌عامل **Ubuntu 24.04 LTS تازه نصب شده**.
2.  یک **نام دامنه** که رکورد A آن به آدرس IP سرور شما اشاره می‌کند.
3.  دسترسی به سرور از طریق **SSH** با کاربر `root`.

## 🚀 نحوه استفاده

1.  با `root` به سرور خود SSH بزنید.
2.  این مخزن را روی سرور خود Clone کنید:
    ```bash
    git clone https://github.com/WebCodex-ir/Ubuntu-WordPress-Boilerplate.git
    cd Ubuntu-WordPress-Boilerplate
    ```
3.  به اسکریپت دسترسی اجرایی بدهید:
    ```bash
    chmod +x install.sh
    ```
4.  اسکریپت را اجرا کنید:
    ```bash
    sudo ./install.sh
    ```
اسکریپت از شما اطلاعات لازم را می‌پرسد و بقیه کارها را به صورت خودکار انجام می‌دهد.

## ⚙️ پس از نصب

پس از اتمام موفقیت‌آمیز اسکریپت، تمام اطلاعات مهم (شامل رمز ریشه دیتابیس) به شما نمایش داده خواهد شد.

### **نصب وردپرس جدید**
* به آدرس `https://your-domain.com` بروید و مراحل نصب ۵ دقیقه‌ای وردپرس را تکمیل کنید.

### **انتقال سایت قدیمی**
برای انتقال سایت قدیمی خود، مراحل زیر را دنبال کنید:

#### 📁 **اتصال با WinSCP (برای فایل‌ها)**
- **پروتکل:** `SFTP`
- **آدرس میزبان:** IP سرور شما
- **پورت:** `22`
- **نام کاربری:** `root`
- **رمز عبور:** رمز SSH سرور شما

پس از اتصال، به مسیر `/var/www/vhosts/your-domain.com` بروید، تمام فایل‌های موجود را پاک کرده و فایل‌های سایت خود را آپلود کنید.

#### 🐬 **اتصال با Navicat (برای دیتابیس)**
- **نوع اتصال:** `MySQL / MariaDB`
- **آدرس میزبان:** IP سرور شما
- **پورت:** `3306`
- **نام کاربری:** `root`
- **رمز عبور:** **رمز ریشه MariaDB** که در انتهای اجرای اسکریپت به شما نمایش داده شد.

پس از اتصال، دیتابیسی که ساخته‌اید را پیدا کرده، جداول آن را خالی کنید و فایل `.sql` بکاپ خود را Import نمایید.

#### 🛡️ **نکته امنیتی بسیار مهم برای Navicat**
استفاده دائمی از کاربر `root` برای اتصال ریموت خطرناک است. پس از اولین اتصال، قویاً توصیه می‌شود یک کاربر جدید مخصوص IP ثابت خود بسازید. در Navicat یک کوئری جدید با دستورات زیر اجرا کنید:
```sql
CREATE USER 'your_user'@'YOUR_STATIC_IP' IDENTIFIED BY 'your_strong_password';
GRANT ALL PRIVILEGES ON your_database_name.* TO 'your_user'@'YOUR_STATIC_IP';
FLUSH PRIVILEGES;
```
سپس یک کانکشن جدید در Navicat با این اطلاعات بسازید.

#### **اصلاح دسترسی‌ها**
بعد از انتقال فایل‌ها، این دستورات را در سرور اجرا کنید تا دسترسی‌ها صحیح شوند:
```bash
sudo chown -R www-data:www-data /var/www/vhosts/your-domain.com
sudo find /var/www/vhosts/your-domain.com -type d -exec chmod 755 {} \;
sudo find /var/www/vhosts/your-domain.com -type f -exec chmod 644 {} \;
```

#### **فعال‌سازی Redis**
پس از انتقال کامل سایت، در پیشخوان وردپرس یک افزونه کش مانند **LiteSpeed Cache** یا **W3 Total Cache** نصب کرده و در بخش Object Cache، آن را به Redis متصل کنید.

## ➕ افزودن سایت یا ساب‌دامین جدید

بعد از راه‌اندازی اولیه سرور، می‌توانید به راحتی دامنه‌ها یا ساب‌دامین‌های جدیدی برای سایت‌های وردپرسی دیگر به همین سرور اضافه کنید. اسکریپت `add-site.sh` این فرآیند را کاملاً خودکار می‌کند.

### نحوه استفاده

1.  مطمئن شوید که رکورد A دامنه یا ساب‌دامین جدید شما به IP سرور اشاره می‌کند و حداقل چند دقیقه از تنظیم آن گذشته است.
2.  اسکریپت `add-site.sh` را روی سرور خود آپلود کنید (اگر از قبل آن را clone نکرده‌اید).
3.  به آن دسترسی اجرایی بدهید:
    ```bash
    chmod +x add-site.sh
    ```
4.  اسکریپت را اجرا کنید:
    ```bash
    sudo ./add-site.sh
    ```
اسکریپت از شما اطلاعات سایت جدید را پرسیده و به صورت هوشمند رمز ریشه دیتابیس را از لاگ‌های نصب قبلی پیدا کرده و تمام مراحل ساخت دیتابیس، نصب وردپرس و گرفتن SSL را برای سایت جدید انجام می‌دهد.

-------------------------------

### **مشکل: خطای "Lost connection to server during query" هنگام بکاپ‌گیری با Navicat**
این خطا زمانی رخ می‌دهد که دیتابیس شما بزرگ است و فرآیند بکاپ‌گیری بیشتر از زمان مجاز پیش‌فرض سرور طول می‌کشد.

**راه‌حل:**
باید محدودیت‌های زمانی و حجم بسته را در کانفیگ MariaDB افزایش دهیم.

1.  فایل کانفیگ دیتابیس را با ویرایشگر باز کنید:
    ```bash
    sudo nano /etc/mysql/mariadb.conf.d/50-server.cnf
    ```

2.  این سه خط را به انتهای بخش `[mysqld]` اضافه کنید:
    ```ini
    wait_timeout = 600
    interactive_timeout = 600
    max_allowed_packet = 256M
    ```

3.  فایل را ذخیره کرده و سرویس دیتابیس را ریستارت کنید:
    ```bash
    sudo systemctl restart mariadb
    ```

حالا مشکل قطع شدن ارتباط هنگام بکاپ‌گیری حل شده است.

--------------------------------


## 🛠️ راهنمای دستورات عیب‌یابی و مدیریت سرور

این مجموعه دستورات، یک جعبه ابزار قدرتمند برای مدیریت و عیب‌یابی سرور وردپرسی است که راه‌اندازی کرده‌ایم. اینها راه‌حل‌های مشکلاتی هستند که در طول فرآیند نصب با آن‌ها مواجه شدیم.

### ۱. مدیریت کاربران دیتابیس (MariaDB User Management)

این دستورات برای مشاهده، تغییر و حذف کاربران دیتابیس استفاده می‌شوند و مستقیماً داخل محیط MariaDB اجرا می‌شوند.

---
**`SELECT user, host FROM mysql.user;`**

* **هدف:** نمایش لیست تمام کاربران دیتابیس به همراه میزبان (host) مجاز برای اتصال آن‌ها.
* **نحوه استفاده:** بعد از ورود به محیط MariaDB، این دستور را اجرا کنید.
* **چه زمانی استفاده می‌شود؟** این بهترین دستور برای شروع عیب‌یابی مشکلات `Access denied` است. ستون `host` به شما می‌گوید که هر کاربر از چه IP یا هاستی اجازه اتصال دارد (`localhost` یعنی فقط از داخل سرور، `%` یعنی از هر جایی).

---
**`RENAME USER 'root'@'localhost' TO 'root'@'%';`**

* **هدف:** تغییر هاست مجاز برای یک کاربر. این دستور به کاربر `root` که قبلاً فقط از `localhost` اجازه اتصال داشت، اجازه می‌دهد تا از هر IP (`%`) متصل شود.
* **نحوه استفاده:** این دستور مدرن و صحیح برای تغییر هاست کاربر است. دستور قدیمی `UPDATE mysql.user` در نسخه‌های جدید MariaDB خطا می‌دهد.
* **چه زمانی استفاده می‌شود؟** زمانی که می‌خواهید دسترسی یک کاربر (مانند `root`) را برای اتصال از راه دور (مثلاً با Navicat) فعال کنید.

---
**`DROP USER 'naveis'@'%';`**

* **هدف:** حذف کامل یک کاربر دیتابیس.
* **نحوه استفاده:** باید نام کاربری و هاست را دقیقاً مشخص کنید. برای مثال، این دستور کاربری به نام `naveis` که از هر هاستی (`%`) اجازه اتصال داشته را حذف می‌کند.
* **چه زمانی استفاده می‌شود؟** برای پاک کردن کاربرانی که به اشتباه ساخته‌اید یا دیگر به آن‌ها نیاز ندارید.

---
**`FLUSH PRIVILEGES;`**

* **هدف:** بارگذاری مجدد جدول دسترسی‌ها در حافظه MariaDB.
* **نحوه استفاده:** این دستور را همیشه بعد از دستوراتی مانند `GRANT`, `CREATE USER`, `RENAME USER` یا `DROP USER` اجرا کنید.
* **چه زمانی استفاده می‌شود؟** برای اطمینان از اینکه تغییراتی که در دسترسی‌های کاربران داده‌اید، بلافاصله اعمال شوند.

---

### ۲. اتصال به دیتابیس از طریق ترمینال

این دستورات در محیط ترمینال سرور (Bash) برای ورود به دیتابیس استفاده می‌شوند.

---
**`grep "MariaDB Root Password" /var/log/wordpress_install_* | tail -n 1`**

* **هدف:** پیدا کردن رمز عبور ریشه (root) دیتابیس MariaDB که توسط اسکریپت نصب به صورت تصادفی ساخته شده است.
* **نحوه استفاده:** این دستور را در ترمینال سرور اجرا کنید. خروجی آن رمز عبور را به شما نشان می‌دهد.
* **چه زمانی استفاده می‌شود؟** زمانی که رمز عبور `root` دیتابیس را فراموش کرده‌اید و برای انجام کارهای مدیریتی به آن نیاز دارید.

---
**`mysql -u root -p'YOUR_CORRECT_ROOT_PASSWORD'`**

* **هدف:** ورود به محیط مدیریت MariaDB با کاربر `root`.
* **نحوه استفاده:** به جای `YOUR_CORRECT_ROOT_PASSWORD`، رمز عبوری که از دستور `grep` بالا به دست آوردید را قرار دهید. دقت کنید که بین `-p` و خود رمز **هیچ فاصله‌ای** نباشد.
* **چه زمانی استفاده می‌شود؟** برای انجام تمام کارهای مدیریتی دیتابیس مانند ساخت کاربر، دادن دسترسی و...

---

### ۳. فعال‌سازی دسترسی از راه دور به دیتابیس

این دستورات برای این هستند که به سرور MariaDB اجازه دهید درخواست‌ها را از خارج از سرور بپذیرد.

---
**`grep "bind-address" /etc/mysql/mariadb.conf.d/50-server.cnf`**

* **هدف:** بررسی اینکه سرور MariaDB به چه آدرس IP گوش می‌دهد.
* **نحوه استفاده:** این دستور را در ترمینال اجرا کنید.
* **چه زمانی استفاده می‌شود؟** برای تشخیص اینکه آیا دیتابیس برای اتصالات ریموت کانفیگ شده است یا نه. خروجی `127.0.0.1` یعنی **فقط اتصالات داخلی** و `0.0.0.0` یعنی **همه اتصالات** پذیرفته می‌شوند.

---
**`sudo sed -i "s/bind-address\s*=\s*127.0.0.1/bind-address = 0.0.0.0/" /etc/mysql/mariadb.conf.d/50-server.cnf`**

* **هدف:** اصلاح خودکار فایل کانفیگ برای اجازه دادن به اتصالات از راه دور.
* **نحوه استفاده:** این دستور خط `bind-address` را پیدا کرده و آن را به `0.0.0.0` تغییر می‌دهد.
* **چه زمانی استفاده می‌شود؟** وقتی که دستور `grep` بالا به شما `127.0.0.1` را نشان داد و شما می‌خواهید اتصال ریموت را فعال کنید.

---
**`sudo systemctl restart mariadb`**

* **هدف:** راه‌اندازی مجدد سرویس دیتابیس.
* **نحوه استفاده:** این دستور را در ترمینال اجرا کنید.
* **چه زمانی استفاده می‌شود؟** همیشه بعد از ایجاد تغییر در فایل‌های کانفیگ MariaDB (مانند تغییر `bind-address`) برای اعمال شدن تغییرات.

---

### ۴. مدیریت فایروال

---
**`sudo ufw status`**

* **هدف:** نمایش وضعیت و لیست قوانین فعال در فایروال سرور (UFW).
* **نحوه استفاده:** این دستور را در ترمینال اجرا کنید.
* **چه زمانی استفاده می‌شود؟** این اولین قدم برای عیب‌یابی هرگونه مشکل اتصال به سرور است. باید مطمئن شوید که پورت‌های `22 (SSH)`, `80 (HTTP)`, `443 (HTTPS)` و `3306 (MariaDB)` در این لیست با وضعیت `ALLOW` قرار دارند.


---
ساخته شده با ❤️ و تجربه فراوان.
